# 我的電腦為什麼崩潰?:認識固態硬碟

>在期中後不久，正當我的還在對著期末作業發愁時，我的電腦就像知道我的心思一樣也為我苦惱。
>
>不過或許是電腦中對於處理情緒的元件不夠完善，在過度接收我的煩惱情緒後，它掛了。
>
>它突如其來的藍色螢幕以及苦惱的表情，直到我完成這篇質量低，沒什麼重點但還是完成的期末作業後都還是謹記於心。

以上幹話。

因為有了上述經歷，且在時間與金錢的教訓下想瞭解為什麼電腦會出錯，儘管他已經非常老了(born in ROC 104)，我還是不願以它時間到了本來就會壞來當作結論，~~再加上我也沒錢換新的~~。

當我的桌面顯示這個畫面，我只知道重新啟動，之前用屢試不爽，但這次我想電腦真的不爽了。
![](https://i.imgur.com/ztsaW0h.png) 

看看那張撲克臉

無論怎麼重開，甚至重灌都顯示這個畫面，所以我認真看了對於錯誤的描述寫著

**page fault in nonpaged area**

之後便開始了這份報告。

## 什麼是Page fault in nonpaged area?

**#本篇皆已Windows為範例系統**

### 記憶體分配
>當程式啟動時，操作系統會根據程式的需求分配記憶體給它。這個過程被稱為「記憶體分配」。
>
>記憶體分配的方式可以使用「分頁（paging）」或「分段（segmentation）」兩種方式。
>
- #### **分頁(paging)**

分頁（paging）將記憶體划分為若干個等大的區塊，稱為「頁（page）」。當程式嘗試存取記憶體時，操作系統會將記憶體地址轉換為頁的地址，再根據所需的頁分配記憶體。

舉個例子，假設我們有一個4KB的記憶體空間，可以被分成8個1KB的頁。當程式嘗試存取記憶體位址3KB時，操作系統會將該位址轉換為第3個頁（即頁3）的地址，然後分配記憶體給程式。

- #### **分段(segmentation)**

分段將記憶體分為若干個不同大小的區塊，稱為「段（segment）」。每個段都有一個唯一的段識別碼（segment identifier），用於對段進行識別。

當程式嘗試存取記憶體時，操作系統會將記憶體地址轉換為段識別碼和偏移量的形式。段識別碼用於指定所需的段，偏移量則用於指定該段內的位置。

分段主要用於組織程式代碼和資料，以便更好地管理和保護記憶體。


### **page分配記憶體方法**


通常情況下，記憶體會被分為兩種類型：*可分頁區域（paged area）*和*不可分頁區域（nonpaged area）*。

>**可分頁區域**的記憶體可以被動態分配給程式或服務使用，當程式或服務不再使用時，記憶體可以被回收。

>**不可分頁區域**的記憶體則是用於系統內核和低階驅動程式使用，通常是不能被動態分配的。

總結來說，**Page fault in nonpaged area**就是Page(分頁)在執行時發生問題，且發生在最重要的系統區域。

---
## page跟電腦崩潰的關聯?

>「**page fault in nonpaged area**」是一個常見的記憶體錯誤訊息，通常會在系統出現記憶體錯誤時顯示。該錯誤的意思是，操作系統試圖存取一個在非分頁區域的記憶體位址，但該位址並不存在。
>
>非分頁區域是指記憶體區域，在記憶體中固定分配且不能進行分頁處理。通常，非分頁區域會留給系統使用，用於儲存一些系統必須的資料。雖然非分頁區域通常是留給系統使用的，但它們也可能和硬碟有所關連。
>
>例如，當系統啟動「休眠」或「深度休眠」功能時，會將所有記憶體中的資料寫入磁碟，以便在後續可以從磁碟快速恢復。為了確保記憶體中的資料能夠正確寫入磁碟，操作系統會將它們暫時存放在非分頁區域中。
>
>因此，當出現「page fault in nonpaged area」錯誤時，可能是因為操作系統試圖存取的記憶體位址並不存在，或者是因為系統在啟動「休眠」或「深度休眠」功能時發生了問題。



這讓我思考是否是電腦在開機時，要求載入的檔案出錯，這邊大概瞭解一下電腦在開關機時所做的事情。

> - 關機 : 
> 
> 在 Windows 系統關機時，操作系統會執行一系列步驟來確保資料安全。首先，它會停止正在運行的應用程式並等待它們終止。然後，它會將所有未保存的檔案儲存到磁碟上，以確保資料不會遺失。最後，它會執行關機命令，終止所有正在運行的系統程式，並斷開電腦與電源的連接。
>
>當 Windows 系統在關機會儲存相關資料，它會將資料轉換為特定的格式，以確保資料在關機後仍能完整儲存。
>
>例如，Windows 系統會將記憶體中的資料轉換為二進位格式（0 和 1 的序列），並將其寫入磁碟。
>這些二進位資料會被儲存在特定的檔案格式中，以便在開機時可以讀取並運用。在 Windows 系統中，這些檔案通常會以「hiberfil.sys」的檔名儲存在磁碟上。
>![]![](https://i.imgur.com/pek2GI9.png)



> - 開機
>
>在電腦開機時，會清空記憶體中的所有資料，以確保記憶體中沒有遺留的資料。接著會載入必要的系統程式與資料(e.g.上述hiberfil.sys)，並將它們存入實體記憶體中。最後，它會載入user的應用程式並執行它們。

由此推斷，我認為是因為我在某次不正常關機時，導致.sys檔內容丟失，所以電腦在開啟時要求獲得這些資料時發生問題，才導致我一直無法正常地進到桌面。

#### 導致電腦崩潰的元兇:SSD損毀


在我不停重灌與格式化後，我理解我自己是無法修好的我電腦，我決定尋求專業，找商家修理，在商家不到1小時的各項測試後我得到的結果是:

**你灌OS的SSD壞了，換一顆新的就好囉。**

~~摁，我就知道是這樣~~

### 硬碟
一般硬碟可分為傳統硬碟(Hard Disk Drive)與固態硬碟（Solid State Disk or Solid State Drive）
> - 傳統硬碟:
> 
> 傳統硬碟由塗滿了磁性物質的碟片所構成，藉由讀寫頭去改變磁性物質的極性方式進而去紀錄資料，由圖可知，硬碟的內部構造其實相當的精密，讀寫頭是藉由碟片運轉時產生的氣流，利用白努力定律而「漂浮」在磁碟片上，其中的間隔距離是用奈米來做計算單位，比粉塵還要微小，一但讀寫頭與碟片直接接觸到的話將會毀損到上面的磁性物質。

> - 固態硬碟
>
>大部分的固態硬碟由三個主要零件組成，包含**Controller控制晶片**、DRAM以及**NAND flash快閃記憶體**。控制晶片是NAND flash與電腦的主要溝通橋樑；NAND flash則是由多個區塊的非揮發性記憶體顆粒所構成，也是資料主要儲存的地方。DRAM是揮發性記憶體，需要持續供給電源才有儲存資料的能力，為非必要的組成零件。

![](https://i.imgur.com/6s79OcI.png)

### SSD規格

SSD 目前 2020 年規格種類共有3種，
Interface 共2種：
1. 和傳統硬碟外觀相同的 SSD 2.5”，也是用 SATA Interface 可以輕易取代傳統硬碟。
2. 規格尺寸 - m2_2280，也是用 SATA 介面。
3. 規格尺寸 - m2_2280 介面 - PCIe G3 1x4 / NVMe。

 ![](https://i.imgur.com/ge8UNtv.png)

上述照片得知 SSD 規格分 3種，但介面（ Interface）分2種 SATA & PCIe/NVMe。

SATA 是傳統硬碟用，無法發揮 NAND 極速特性，屬舊型 Interface。
PCIe/NVMe 是專為 SSD 內的 NAND 開發的新協定，可以發揮 NAND 的極速。

#### SATA SSD
這是最早出現市面的 SSD，當時是為了取代暢銷的傳統硬碟而設計，外型就是和一般 2.5”傳統硬碟完全相同，也是採用 SATA 介面，安裝和傳統硬碟相同，毫無困難，可以輕易取代。
目前市面規格 SATA 6.0Gb/s, 讀取時間 560 MB/s ,寫入時間 510 MB/s。

#### M.2 PCIe (PCI Express) / NVMe
這是搭配目前最高速的 PCIe 介面，NVMe 也是較新 SSD規格，如是舊款主機板可能不支援，但近期新款主機板都已有支援，據說近年的 Notebook 都搭配 PCIe / NVMe 的 SSD。
目前市面規格 3D NAND，讀取時間 3,400 MB/s，寫入時間 3,000 MB/s。

#### M.2 SATA
這是比 PCIe / NVMe 更早期介面，適用較舊款主機板，
目前市面規格 M.2 SATA，讀取時間 560MB/s, 寫入時間 510MB/s。

---
### Controller 控制晶片
Controller：就是負責當外部有檔案要寫入時，就是先由 Controller 已內建『File System』將檔案分數段 Blocks『平均寫入』每一顆 NAND Flash Memory 儲存。當 Windows 下指令要讀取檔案時，也是由此 Controller 負責至各 NAND 將該檔案所有的 Blocks 取出，依序傳輸給 Windows。且保證順序，數量正確無誤，檔案才完整可正常使用。

### NAND 快閃記憶體：
NAND 快閃記憶體:沒有專用的地址線，不能直接定址，是通過一個間接的、類似I/O的介面來發送命令和地址來進行控制的，這就意味著NAND快閃記憶體只能夠以頁的方式進行訪問。相對於NOR快閃記憶體而言，NAND快閃記憶體只需要更少的邏輯閘就可以儲存相同數量的位，因此，NAND快閃記憶體比NOR快閃記憶體體積更小，儲存密度更大。

### NAND
NAND 的儲存單位也採用『邏輯虛擬』設計，且不同廠牌、型號....數值不同。

但制定的基本標準如下：
> 1. Unit 是 NAND 最基本儲存單位，Size=512 byte。
> 2. Page 是網格上的每一列（行），在 NAND 上稱為『Page』。通常數量都是 32、64、128、256、512.../unit，Size 32、64、128...KB，基本上每一層有多少數量的列就相同數量的 Page，但各廠牌設計也有不同。一個page上所有的 unit共用一字元線(Word line）所以 NAND 讀寫一定是一個 Page 一個 Page同時進行。  
> 3. Block 是 32,64,128,256,512….Page 組成的『區塊』且是『3D立體』，想像成陣列 Array或巨型的『魔術方塊』較易理解。
> ![](https://i.imgur.com/dir9GnT.png)


NAND儲存單位NAND 讀取與寫入原理有點複雜，
NAND 『讀取，寫入』是一個 Page 一個Page 進行。但 **寫入前必須先將要寫入該 page 的整個 Block 擦除乾淨（Block erasure) 才可寫入。擦除原理就是將 Block 內所有的 bit 變為『1』狀態＝Free 。** 擦除作業只能以「Block」進行，無法以較小的 page。

所以程序是, 先清除一個大的 Block 空間 → 資料才寫入一個小的 page 內。
例如：為了寫入小量的 16KB 資料（page) 需先將一個大量的 512KB（block) 所有 bit 都寫成”1”(Full “11111111”) 變成 Free ，才可寫入 16KB 資料。

![](https://i.imgur.com/LU5UVqt.png)

 
 **就是 SSD 因常『抹除』，寫入比讀出耗時，也導致 NAND 壽命減原因。** 
如果一直在同一個 Block 寫入與清除資料，這些Block 的壽命會消耗很快，為了儘量減少Erasure的次數，有效率的Block 管理技術就非常重要。
當晶片漸漸磨損，Erasure與讀寫速度會變非常慢，而且需要更多次數 Retry。
NAND Flash還有一項限制就是區塊內的資料只能序列性的寫入，無法像傳統硬碟隨機讀寫(Randon read/write)。

了解上述問題後，接下來說明**SSD的耗損平均 (Wear Leveling) & Trim（修剪) 原理。**


> - ### Wear Leveling（耗損平均）是什麼？
> 
>SSD NAND 常會被做『寫入』動作，且 Blocks 數量龐大，那就要設法讓每一 Block 被寫入次數是平均的，避免某些 Blocks 時常被寫入而耗損較嚴重，其它不常被寫入的 Blocks 卻耗損較輕微。
簡單形容類似避免『路面』到處坑坑疤疤，最好是每一路段都平均使用，勿集中常使用某>一路段，造成這一路段耗損嚴重，其它不常>使用路段卻耗損輕微。
最好是一整層路面平均耗損，使用一陣子後又是一整層平均耗損，如此即可保持路面永遠是平整，無坑坑疤疤現象，直到路面已薄到無法再耗損才報廢。
 
> - ### SSD Trim（修剪) 的功能是什麼？
> 
>先以傳統硬碟來說明，在 Windows, Mac, Linux 下使用傳統硬碟，當刪除檔案時，該檔案在硬碟磁片上只是先被標示成『已刪除』，該檔案在磁片上所佔用的 Blocks 都還存在原資料，並未被清除（未被 Full “00000000”），只是當檔案管理系統 File manage 讀到此『標示已刪除』時會略過不讀，如此才有機會隨時『還原檔案』。
>註：各位應該有注意到，Windows,Mac, Linux.. 下 Copy 寫入一支 1GB File 約需幾十秒才可完成，但 Delete File 卻是瞬間完成，足證這『瞬間』只是做了『標示已刪除』的動作，絕不足將 1GB 資料100% 清空（未被 Full “00000000”）。 
>
>但當有新檔案要寫入時，只要是磁片後面還有未使用區塊（Unused Blocks)，一律先寫入這些未使用的區塊，不會先去寫入『已刪除』區塊，就是避免覆蓋已刪除檔案，提供隨時『還原檔案』的機會。
但如磁片已被寫滿，無任何未使用區塊可用時，新檔案就只能寫入那些標示『已刪除』的區塊，只要一被寫入新資料，原舊有資料即已被覆蓋，絕不可能『還原』。
>
>SSD 也有類似此機制，一些『已刪除』檔案所佔用的 Blocks 也只是被標示『已刪除』，原檔案資料還存在，並無被 Full”11111111”，也是有機會『還原』。
當有檔案要寫入時，也是去找未使用區塊寫入。
>但 NAND 有一致命缺點，如某些區塊 Blocks 常被頻繁的讀＋寫＋抹除 (Full “11111111”)其『電荷電壓』會加速減弱，導致這些區塊無法再使用，變成 Bad Blocks，如此整個 NAND 就會到處散佈這些 Bad Blocks，將導致 SSD 讀寫異常。為了避免發生此狀況，就設計了『Trim』這機制來改善。
>
>Trim 的主要功能是，趁 SSD 閒置時，先去啟動『主動垃圾收集機制』直接清除那些標示『已刪除』的 Blocks，供隨時寫入新資料 Pages。
事先清除的優點是，不必等到真正有新資料要寫入時，才去『搬移殘餘 Pages』→『Full “11111111”』→『寫入新資料Pages』。
Trim 是SSD專用功能，某些作業系統版本，非設定自動啟用，可能需要至 /設定/ Trim 手動啟用。
>
>『主動垃圾收集機制』的功能也是趁 SSD 閒置時，主動去收集一些『屬於同一支檔案的所有Pages』集中存放，減少『斷離現象』聽起來有點像『資料重整』。
>
>Trim 與主動垃圾收集機制同時運作即可延長 SSD 的使用壽命，並提升 SSD讀寫效率。是非常聰明的機制，目前新規格 SSD NAND 都有提供此項機制。 以前常聽說 『SSD 不要寫滿，一定要預留約 20% 空間供暫存用，否則讀寫速度會變慢』。
目前新款 SSD已內建此機制，使用者不必再為此操心。
SSD因讀寫時需要遷移殘遺的 Pages，所以需預留一些暫存空間，目前 SSD 設計是已內建『暫存空間』，Windows, MacOS, Linux….. 下是無法識別，使用者也看不到，當然更無法去使用這些空間，這是一種『保護』機制。

## 所以是SSD壞了?

「page fault in nonpaged area」錯誤通常是因為操作系統試圖存取的記憶體位址錯誤或並不存在。

例如：

1. 記憶體損壞：記憶體晶片本身可能有瑕疵，導致記憶體位址無法存取。

2. 記憶體分配錯誤：操作系統可能會將記憶體分配到無效的位址，導致記憶體位址無法存取。

3. 硬體錯誤：記憶體插槽、主機板或其他硬體可能有問題，導致記憶體位址無法存取。

#### 錯誤的記憶體位址

錯誤的位址通常是指記憶體位址無效，操作系統無法存取。這種情況下，操作系統會拋出「page fault in nonpaged area」錯誤，提示記憶體位址無效。

記憶體位址無效的原因可能有很多，例如：

1. 原位址已包含資料：如果記憶體位址已經被分配，並包含有效資料，那麼操作系統就無法再次存取該位址。

2. 超出限制的位址：記憶體位址是有限的，如果超出了可存取的範圍，那麼操作系統就無法存取該位址。

3. 該位址格是不被接受：某些記憶體位址可能是保留的，不能被普通的應用程式或服務存取。如果操作系統嘗試存取這些位址，就會拋出「page fault in nonpaged area」錯誤。

看到這裡，我想我也終於明白為什麼是SSD所造成的問題。
## 結論
在最初我看到page fault in nonpaged area時，想到的是沒有正確載入分頁之類的，後來才了解到是在非分頁的區域產生的讀取錯誤，再來去瞭解到SSD是有因為其寫入跟抹除的方式會大大影響到他的使用壽命，我才瞭解到並不一定是電腦內系統檔未被正確呼傳，也有可能單純是硬體本身因外力因素所導致他內部邏輯元件等出錯，導致在開關機或其他時候將包含系統在內的資料放在錯誤的位址，才引發後續這個Error。

但另一方面也覺得除了終於搞定這個麻煩的錯誤以外，也能夠瞭解到SSD儲存/抹除資料的方式以及可能發生的問題，也算是收穫許多。

## 附錄:在故障排除中發現的意外問題

### 處理器驅動問題
在我獨自看到google上一堆解決辦法時，發現可以藉著查詢每次當機時，系統所儲存的傾印檔來觀察是哪個部分出錯，那時候的我發現傾印檔最終都導向這個問題，在追根究柢之後發現這是因為windows在更新的時候會"順便"尋找其他軟、硬體的驅動並且加以更新。
![](https://i.imgur.com/OjpxWh6.png)
但因為我是使用第五代的intel處理器，官方本身已不支援更新驅動，所以windows就十分熱心地找了**最新**的版本更新我i5 - 4460的驅動。

~~但這並不是我開不了機的真正原因~~

### 拆了SSD測試卻沒發現問題
之後我有想過，既然是開機時找不到OS檔，那會不會是因為我SSD到寫入的上限或是其他故障問題，所以我對硬碟分別測試，僅用HDD、SSD灌OS，並且嘗試開機，但無論是用哪一顆硬碟都無法成功進入桌面，這也在電腦維修後成為我永遠無法解開的懸案。

## 後記
只能說雖然網路發達的現代，很多事情可以只要google就找到答案，但對於很多技術性的操作我認為還是要由擁有相關證書或是學位的專才解決才是妥當的，一味的依賴網路只能獲得**不一定正確的解答**，若對此產生依賴可能就只會知道偏方，而不知道事情的原貌與正解。

以上 就是我的心得報告。

## 文獻出處
1. [OpenAI ChatGPT](https://chat.openai.com/chat)

2. [凌威科技](https://www.linwei.com.tw/forum-detail/23/#SSD%20%E5%9B%BA%E6%85%8B%E7%A1%AC%E7%A2%9F%E5%8E%9F%E7%90%86) 

3. [wiki百科](https://zh.wikipedia.org/wiki/%E5%9B%BA%E6%80%81%E7%A1%AC%E7%9B%98)
